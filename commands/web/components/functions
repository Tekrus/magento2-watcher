#!/bin/bash
#ddev-generated - Do not modify this file; your modifications will be overwritten.

# Check if gum is installed
function check_gum() {
    if ! command -v gum &>/dev/null; then
        echo -e "\n${txtred}gum is not installed.${txtrst}"
        echo -e "${txtgrn}Installing gum...${txtrst}"
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://repo.charm.sh/apt/gpg.key | gpg --dearmor -o /etc/apt/keyrings/charm.gpg
        echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | tee /etc/apt/sources.list.d/charm.list
        apt-get update && apt-get install -y gum
    fi
}

# Check if mysql is installed
function check_mysql() {
    if ! command -v mysql &>/dev/null; then
        echo -e "\n${txtred}mysql command not found.${txtrst}"
        echo -e "${txtred}Please ensure MySQL client is installed.${txtrst}"
        exit 1
    fi
}

# Generate grunt-local-themes.js content
function generate_grunt_config() {
    local theme_configs="$1"
    cat > "${THEMES_CONFIG_FILE}" << 'HEADER'
'use strict';

// Generated by ddev-grunt-browsersync

module.exports = {
HEADER
    echo "$theme_configs" >> "${THEMES_CONFIG_FILE}"
    cat >> "${THEMES_CONFIG_FILE}" << 'FOOTER'
};
FOOTER
}

# Get theme path from user
function get_theme_path() {
    local theme_code="$1"
    local default_path="app/design/frontend/${theme_code}"
    gum input --cursor.foreground "#CCC" \
        --prompt "Theme path (${theme_code}): " \
        --prompt.foreground="#84CC16" \
        --placeholder "app/design/frontend/Vendor/theme" \
        --value "${default_path}"
}

# Required npm packages
REQUIRED_PACKAGES=(
    "grunt"
    "grunt-browser-sync"
    "grunt-contrib-clean"
    "grunt-contrib-cssmin"
    "grunt-contrib-imagemin"
    "grunt-contrib-jasmine"
    "grunt-contrib-less"
    "grunt-contrib-watch"
    "grunt-eslint"
    "grunt-exec"
    "grunt-replace"
    "grunt-styledocco"
    "grunt-template-jasmine-requirejs"
    "grunt-text-replace"
    "load-grunt-config"
    "time-grunt"
    "underscore"
    "browser-sync"
)

# Ensure npm packages are installed
function ensure_npm_packages() {
    local pkg_file="package.json"

    if [[ ! -f "${pkg_file}" ]]; then
        echo -e "\n${txtcyn}Creating package.json with Grunt and BrowserSync packages...${txtrst}"
        cat > "${pkg_file}" << 'PKGEOF'
{
  "devDependencies": {
    "grunt": "~1.6.1",
    "grunt-browser-sync": "~2.2.0",
    "grunt-contrib-clean": "~2.0.1",
    "grunt-contrib-cssmin": "~5.0.0",
    "grunt-contrib-imagemin": "~4.0.0",
    "grunt-contrib-jasmine": "~4.0.0",
    "grunt-contrib-less": "~3.0.0",
    "grunt-contrib-watch": "~1.1.0",
    "grunt-eslint": "~24.3.0",
    "grunt-exec": "~3.0.0",
    "grunt-replace": "~2.0.2",
    "grunt-styledocco": "~0.3.0",
    "grunt-template-jasmine-requirejs": "~0.2.3",
    "grunt-text-replace": "~0.4.0",
    "load-grunt-config": "~4.0.1",
    "time-grunt": "~2.0.0",
    "underscore": "1.13.7",
    "browser-sync": "~3.0.3"
  }
}
PKGEOF
        echo -e "${txtgrn}✓ Created package.json${txtrst}"
    else
        local missing_packages=()

        for pkg in "${REQUIRED_PACKAGES[@]}"; do
            if ! grep -q "\"${pkg}\"" "${pkg_file}"; then
                missing_packages+=("${pkg}")
            fi
        done

        if [[ ${#missing_packages[@]} -gt 0 ]]; then
            echo -e "\n${txtcyn}Adding missing packages to package.json...${txtrst}"
            local temp_script=$(mktemp)

            cat > "${temp_script}" << 'NODEEOF'
const fs = require('fs');
const pkgFile = process.argv[2];
const pkg = JSON.parse(fs.readFileSync(pkgFile, 'utf8'));
const missing = JSON.parse(process.argv[3]);
const versions = {
    'grunt': '~1.6.1',
    'grunt-browser-sync': '~2.2.0',
    'grunt-contrib-clean': '~2.0.1',
    'grunt-contrib-cssmin': '~5.0.0',
    'grunt-contrib-imagemin': '~4.0.0',
    'grunt-contrib-jasmine': '~4.0.0',
    'grunt-contrib-less': '~3.0.0',
    'grunt-contrib-watch': '~1.1.0',
    'grunt-eslint': '~24.3.0',
    'grunt-exec': '~3.0.0',
    'grunt-replace': '~2.0.2',
    'grunt-styledocco': '~0.3.0',
    'grunt-template-jasmine-requirejs': '~0.2.3',
    'grunt-text-replace': '~0.4.0',
    'load-grunt-config': '~4.0.1',
    'time-grunt': '~2.0.0',
    'underscore': '1.13.7',
    'browser-sync': '~3.0.3'
};

if (!pkg.devDependencies) pkg.devDependencies = {};
missing.forEach(p => {
    if (!pkg.devDependencies[p]) {
        pkg.devDependencies[p] = versions[p] || 'latest';
        console.log('Adding: ' + p);
    }
});
fs.writeFileSync(pkgFile, JSON.stringify(pkg, null, 2) + '\n');
NODEEOF

            local missing_json=$(printf '%s\n' "${missing_packages[@]}" | jq -R . | jq -s .)
            node "${temp_script}" "${pkg_file}" "${missing_json}"
            rm -f "${temp_script}"
        fi
    fi

    echo -e "${txtcyn}Installing npm packages...${txtrst}"
    if npm install; then
        echo -e "${txtgrn}✓ npm packages installed successfully${txtrst}"
    else
        echo -e "${txtred}✗ Failed to install npm packages${txtrst}"
        return 1
    fi
    return 0
}

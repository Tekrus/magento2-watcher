#!/bin/bash
#ddev-generated - Do not modify this file; your modifications will be overwritten.

function setup_npm_packages() {
    if [[ ! -f "package.json" ]]; then
        echo -e "\n${txtcyn}Creating package.json with Grunt and BrowserSync packages...${txtrst}"
        cat > package.json << 'PKGEOF'
{
  "devDependencies": {
    "grunt": "~1.6.1",
    "grunt-browser-sync": "~2.2.0",
    "grunt-contrib-clean": "~2.0.1",
    "grunt-contrib-cssmin": "~5.0.0",
    "grunt-contrib-imagemin": "~4.0.0",
    "grunt-contrib-jasmine": "~4.0.0",
    "grunt-contrib-less": "~3.0.0",
    "grunt-contrib-watch": "~1.1.0",
    "grunt-eslint": "~24.3.0",
    "grunt-exec": "~3.0.0",
    "grunt-replace": "~2.0.2",
    "grunt-styledocco": "~0.3.0",
    "grunt-template-jasmine-requirejs": "~0.2.3",
    "grunt-text-replace": "~0.4.0",
    "load-grunt-config": "~4.0.1",
    "time-grunt": "~2.0.0",
    "underscore": "1.13.7"
  }
}
PKGEOF
        echo -e "${txtgrn}✓ Created package.json${txtrst}"
    else
        echo -e "\n${txtcyn}package.json already exists${txtrst}"
    fi

    echo -e "${txtcyn}Installing npm packages...${txtrst}"
    if ddev exec npm install; then
        echo -e "${txtgrn}✓ npm packages installed successfully${txtrst}"
    else
        echo -e "${txtred}✗ Failed to install npm packages${txtrst}"
        exit 1
    fi
}

# Initialize themes from database with interactive selection
function init_grunt_themes() {
    check_gum
    check_mysql

    setup_npm_packages

    local db_themes=$(get_themes_from_db)
    local db_theme_count=$(echo "${db_themes}" | wc -w)

    if [[ -z "${db_themes}" ]]; then
        echo -e "\n${txtred}No themes found in Magento database.${txtrst}"
        echo -e "${txtylw}Make sure Magento is installed and themes are registered.${txtrst}\n"
        exit 1
    fi

    echo -en "\n${txtcyn}Found ${txtpur}${db_theme_count} themes${txtcyn} in your database.${txtrst}\n\n"

    # Prepare gum choose options with already selected themes pre-selected
    local existing_themes=$(get_existing_themes)
    local select_args=""

    for theme in ${db_themes}; do
        if [[ "${existing_themes}" == *"${theme}"* ]]; then
            select_args="${select_args} --selected ${theme}"
        fi
    done

    local theme_options=$(echo "${db_themes}" | tr '\n' ' ')
    local selected_themes=$(gum choose \
        --cursor-prefix "[ ] " \
        --unselected-prefix "[ ] " \
        --selected-prefix "[✓] " \
        ${select_args} \
        --no-limit \
        ${theme_options})

    if [[ -z "${selected_themes}" ]]; then
        echo -e "\n${txtylw}No themes selected.${txtrst}\n"
        exit 0
    fi

    # Generate new config with selected themes
    local config_content=""

    for theme in ${selected_themes}; do
        local existing_path=""
        local existing_area="frontend"
        local existing_locale="en_US"

        # Try to get existing config
        if theme_in_config "${theme}"; then
            # Extract existing values from current config
            existing_path=$(grep -A2 "'${theme}':" "${THEMES_CONFIG_FILE}" 2>/dev/null | grep -E "path:" | sed "s/.*path:.*'\([^']*\)'.*/\1/" || echo "")
            existing_area=$(grep -A2 "'${theme}':" "${THEMES_CONFIG_FILE}" 2>/dev/null | grep -E "area:" | sed "s/.*area:.*'\([^']*\)'.*/\1/" || echo "frontend")
            existing_locale=$(grep -A2 "'${theme}':" "${THEMES_CONFIG_FILE}" 2>/dev/null | grep -E "locale:" | sed "s/.*locale:.*'\([^']*\)'.*/\1/" || echo "en_US")
        fi

        # Ask for path if not existing
        local theme_path
        if [[ -n "${existing_path}" ]]; then
            theme_path="${existing_path}"
        else
            theme_path=$(get_theme_path "${theme}")
            if [[ -z "${theme_path}" ]]; then
                theme_path="app/design/frontend/${theme}"
            fi
        fi

        # Ask for locale
        local theme_locale=$(gum input \
            --cursor.foreground "#CCC" \
            --prompt "Locale for ${theme}: " \
            --prompt.foreground="#84CC16" \
            --placeholder "en_US" \
            --value "${existing_locale}")

        if [[ -z "${theme_locale}" ]]; then
            theme_locale="en_US"
        fi

        config_content="${config_content}
    '${theme}': {
        area: '${existing_area}',
        name: '${theme}',
        locale: '${theme_locale}',
        files: [
            'css/styles-m',
            'css/styles-l'
        ],
        dsl: 'less'
    },"
    done

    # Remove trailing comma
    config_content=$(echo "${config_content}" | sed 's/,$//')

    # Generate new config file
    echo "Generating ${THEMES_CONFIG_FILE}..."
    generate_grunt_config "${config_content}"

    local selected_count=$(echo "${selected_themes}" | wc -w)
    echo -e "\n${txtgrn}✓ Added ${selected_count} theme(s) to ${THEMES_CONFIG_FILE}${txtrst}"
    echo -e "${txtgrn}✓ npm packages installed${txtrst}"
    echo -e "${txtgrn}✓ Run: ddev exec grunt themes${txtrst}\n"
}
